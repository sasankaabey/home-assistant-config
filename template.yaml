- sensor:
    - name: "Open Floorplan Average Illuminance"
      unique_id: open_floorplan_average_illuminance
      state: >-
        {{ [
          states('sensor.kitchen_occupancy_sensor_illuminance') | float(0),
          states('sensor.dining_room_occupancy_sensor_illuminance') | float(0),
          states('sensor.living_room_occupancy_illuminance') | float(0)
        ] | sum / 3 | round(1) }}
      unit_of_measurement: lx
      device_class: illuminance

- sensor:
  - name: "TV Mount Position"
    state: >
      {{ "Down" if is_state('input_boolean.tv_mount_should_be_down', 'on') else "Up" }}
    icon: >
      {% if is_state('input_boolean.tv_mount_should_be_down', 'on') %}
        mdi:chevron-down
      {% else %}
        mdi:chevron-up
      {% endif %}

- sensor:
    - name: "Litterbot Nag Message"
      state: >
        {% set messages = [
          "Hey! The Litterbot is broken. Let's take care of business.",
          "Still broken. Please fix it before the cat union calls a strike.",
          "Seriously, it's been long enough. That bot isn't going to fix itself.",
          "They've held it in long enough. Proceed to emergency cleanup mode.",
          "You are now enemy #1 in the eyes of your cats. Fix. The. Robot.",
          "We're nearing DEFCON 1. Poopocalypse is imminent.",
          "Fur will fly. Litter will scatter. Handle the situation.",
          "This is not a drill. Litterbot status: shameful.",
          "Legends speak of a working Litterbot. Become that legend.",
          "Last warning: save your soul, scoop the hole."
        ] %}
        {% set idx = states('input_number.litterbot_nag_message_index') | int %}
        {{ messages[idx % messages|length] }}

- binary_sensor:
    - name: "Kids Home"
      unique_id: kids_home
      state: "{{ is_state('group.kids', 'home') }}"
    - name: "Household Announce All"
      unique_id: household_announce_all
      state: >-
        {% set now_minutes = now().hour * 60 + now().minute %}
        {% set kids_home = is_state('group.kids', 'home') %}
        {% if kids_home %}
          {{ now_minutes >= 420 and now_minutes < 1200 }}
        {% else %}
          {{ now_minutes >= 420 and now_minutes < 1320 }}
        {% endif %}
    - name: "Household Announce Adults"
      unique_id: household_announce_adults
      state: >-
        {% set now_minutes = now().hour * 60 + now().minute %}
        {{ now_minutes >= 420 and now_minutes < 1320 }}

# Fallback binary sensors: prefer local (tuya_local) over cloud (tuya)
# These provide resilience when local integration becomes unavailable
- binary_sensor:
    - name: "Washer Door"
      unique_id: washer_door_fallback
      device_class: door
      state: >-
        {# Prefer tuya_local, fallback to tuya cloud #}
        {% if states('binary_sensor.washer_door_local') not in ['unavailable', 'unknown'] %}
          {{ states('binary_sensor.washer_door_local') }}
        {% else %}
          {{ states('binary_sensor.contact_sensor_door') }}
        {% endif %}
      availability: >-
        {{ states('binary_sensor.washer_door_local') not in ['unavailable', 'unknown']
           or states('binary_sensor.contact_sensor_door') not in ['unavailable', 'unknown'] }}
      icon: >-
        {% if is_state('binary_sensor.washer_door', 'on') %}
          mdi:washing-machine-alert
        {% else %}
          mdi:washing-machine
        {% endif %}

    - name: "Dryer Door"
      unique_id: dryer_door_fallback
      device_class: door
      state: >-
        {# Prefer tuya_local, fallback to tuya cloud #}
        {% if states('binary_sensor.dryer_door_local') not in ['unavailable', 'unknown'] %}
          {{ states('binary_sensor.dryer_door_local') }}
        {% else %}
          {{ states('binary_sensor.contact_sensor_2_door') }}
        {% endif %}
      availability: >-
        {{ states('binary_sensor.dryer_door_local') not in ['unavailable', 'unknown']
           or states('binary_sensor.contact_sensor_2_door') not in ['unavailable', 'unknown'] }}
      icon: >-
        {% if is_state('binary_sensor.dryer_door', 'on') %}
          mdi:tumble-dryer-alert
        {% else %}
          mdi:tumble-dryer
        {% endif %}

# Dashboard display sensors: show state + which integration is providing data
- sensor:
    - name: "Washer Door Status"
      unique_id: washer_door_status_display
      state: >-
        {# Show state + which integration is active #}
        {% set state = states('binary_sensor.washer_door') %}
        {% set local_available = states('binary_sensor.washer_door_local') not in ['unavailable', 'unknown'] %}
        {% set state_text = "Closed" if state == 'off' else "Open" if state == 'on' else "Unknown" %}
        {% set source = "tuya_local" if local_available else "tuya" %}
        {{ state_text }} ({{ source }})
      icon: >-
        {% if is_state('binary_sensor.washer_door', 'on') %}
          mdi:washing-machine-alert
        {% else %}
          mdi:washing-machine
        {% endif %}

    - name: "Dryer Door Status"
      unique_id: dryer_door_status_display
      state: >-
        {# Show state + which integration is active #}
        {% set state = states('binary_sensor.dryer_door') %}
        {% set local_available = states('binary_sensor.dryer_door_local') not in ['unavailable', 'unknown'] %}
        {% set state_text = "Closed" if state == 'off' else "Open" if state == 'on' else "Unknown" %}
        {% set source = "tuya_local" if local_available else "tuya" %}
        {{ state_text }} ({{ source }})
      icon: >-
        {% if is_state('binary_sensor.dryer_door', 'on') %}
          mdi:tumble-dryer-alert
        {% else %}
          mdi:tumble-dryer
        {% endif %}