health_check_stale_entities:
  alias: Health check stale entities
  description: Add a todo item if an entity has not updated within N days.
  mode: parallel
  fields:
    entities:
      description: List of entities or dicts with entity_id and name.
      example: "binary_sensor.dining_room_smoke or {entity_id: binary_sensor.dining_room_smoke, name: Dining Room Smoke Detector}"
    stale_days:
      description: Number of days without updates before flagging.
      example: 30
    todo_list:
      description: Todo list entity to receive items.
      example: todo.shopping_list
  sequence:
    - variables:
        stale_days: "{{ stale_days | default(30) | int }}"
        todo_list: "{{ todo_list | default('todo.shopping_list') }}"
        notify_targets: "{{ notify_targets | default([]) }}"
        notify_title: "{{ notify_title | default('Home maintenance') }}"
    - repeat:
        for_each: "{{ entities | default([]) }}"
        sequence:
          - variables:
              entity_id: >-
                {{ repeat.item.entity_id if repeat.item is mapping else repeat.item }}
              label: >-
                {{ repeat.item.name if repeat.item is mapping else state_attr(entity_id, 'friendly_name') }}
              last_updated: >-
                {{ states[entity_id].last_updated if states[entity_id] is not none else none }}
              is_stale: >-
                {{ last_updated is none or
                   (as_timestamp(now()) - as_timestamp(last_updated)) > (stale_days * 86400) }}
              month_tag: "{{ now().strftime('%Y-%m') }}"
              todo_item: >-
                {{ 'Health check: ' ~ (label or entity_id) ~ ' (no update in ' ~ stale_days ~ 'd, ' ~ month_tag ~ ')' }}
          - if:
              - condition: template
                value_template: "{{ is_stale }}"
            then:
              - service: todo.add_item
                target:
                  entity_id: "{{ todo_list }}"
                data:
                  item: "{{ todo_item }}"
              - if:
                  - condition: template
                    value_template: "{{ notify_targets | count > 0 }}"
                then:
                  - repeat:
                      for_each: "{{ notify_targets }}"
                      sequence:
                        - service: "{{ repeat.item }}"
                          data:
                            title: "{{ notify_title }}"
                            message: "{{ todo_item }}"

alexa_announce_router:
  alias: Alexa announcement router
  description: Route announcements based on quiet hours and audience.
  mode: queued
  fields:
    message:
      description: Announcement text to speak.
      example: "The washer is done."
    audience:
      description: Audience routing (auto, all, adults, living_room).
      example: "auto"
  sequence:
    - variables:
        audience: "{{ audience | default('auto') }}"
        targets_all: !include alexa_announce_targets_all.yaml
        targets_adult: !include alexa_announce_targets_adult.yaml
        kids_home: >-
          {% set val = states('binary_sensor.kids_home') %}
          {% if val in ['on', 'off'] %}
            {{ val == 'on' }}
          {% else %}
            {{ is_state('group.kids', 'home') }}
          {% endif %}
        can_announce_all: >-
          {% set val = states('binary_sensor.household_announce_all') %}
          {% if val in ['on', 'off'] %}
            {{ val == 'on' }}
          {% else %}
            {% set now_minutes = now().hour * 60 + now().minute %}
            {% if kids_home %}
              {{ now_minutes >= 420 and now_minutes < 1200 }}
            {% else %}
              {{ now_minutes >= 420 and now_minutes < 1320 }}
            {% endif %}
          {% endif %}
        can_announce_adults: >-
          {% set val = states('binary_sensor.household_announce_adults') %}
          {% if val in ['on', 'off'] %}
            {{ val == 'on' }}
          {% else %}
            {% set now_minutes = now().hour * 60 + now().minute %}
            {{ now_minutes >= 420 and now_minutes < 1320 }}
          {% endif %}
        household_home: "{{ is_state('group.household', 'home') }}"
    - condition: template
      value_template: "{{ household_home }}"
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ audience == 'living_room' and can_announce_adults }}"
          sequence:
            - service: notify.alexa_media
              data:
                target:
                  - media_player.living_room_alexa
                message: "{{ message }}"
                data:
                  type: announce
                  method: all
        - conditions:
            - condition: template
              value_template: "{{ audience == 'all' and can_announce_all }}"
          sequence:
            - service: notify.alexa_media
              data:
                target: "{{ targets_all }}"
                message: "{{ message }}"
                data:
                  type: announce
                  method: all
        - conditions:
            - condition: template
              value_template: "{{ audience == 'adults' and can_announce_adults }}"
          sequence:
            - service: notify.alexa_media
              data:
                target: "{{ targets_adult }}"
                message: "{{ message }}"
                data:
                  type: announce
                  method: all
      default:
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ can_announce_all }}"
              sequence:
                - service: notify.alexa_media
                  data:
                    target: "{{ targets_all }}"
                    message: "{{ message }}"
                    data:
                      type: announce
                      method: all
            - conditions:
                - condition: template
                  value_template: "{{ can_announce_adults }}"
              sequence:
                - service: notify.alexa_media
                  data:
                    target: "{{ targets_adult }}"
                    message: "{{ message }}"
                    data:
                      type: announce
                      method: all

litterbot_alexa_announce:
  alias: Litterbot Alexa announcement
  description: Announce Litterbot messages with kid-aware quiet hours.
  mode: queued
  fields:
    message:
      description: Announcement text to speak.
      example: "Litterbot needs attention."
  sequence:
    - service: script.alexa_announce_router
      data:
        message: "{{ message }}"

alexa_announce_living_room:
  alias: Living Room Alexa announcement
  description: Reliable announce on the living room Alexa device.
  mode: queued
  fields:
    message:
      description: Announcement text to speak.
      example: "Heads up: the washer is done."
  sequence:
    - service: script.alexa_announce_router
      data:
        message: "{{ message }}"
        audience: living_room

litterbot_tts_announce:
  alias: Litterbot TTS announcement
  description: Speak Litterbot messages with kid-aware quiet hours.
  mode: queued
  fields:
    camden_message:
      description: Message spoken in Camden's voice.
      example: "Camden grumbles: fix the Litterbot."
    poe_message:
      description: Message spoken in Poe's voice.
      example: "Poe says: hurry up."
    volume_level:
      description: Volume level for TTS (0.0-1.0).
      example: 0.7
  sequence:
    - variables:
        tts_targets_all: !include tts_announce_targets_all.yaml
        tts_targets_adult: !include tts_announce_targets_adult.yaml
        camden_tts: >-
          {{ states('input_select.litterbot_camden_tts_engine') | default('tts.elevenlabs') }}
        poe_tts: >-
          {{ states('input_select.litterbot_poe_tts_engine') | default('tts.elevenlabs') }}
        camden_voice: "{{ states('input_text.litterbot_camden_tts_voice') }}"
        poe_voice: "{{ states('input_text.litterbot_poe_tts_voice') }}"
        tts_volume: >-
          {{ volume_level | default(states('input_number.litterbot_tts_volume') | float(0.6)) | float }}
        can_announce_all: "{{ is_state('binary_sensor.household_announce_all', 'on') }}"
        can_announce_adults: "{{ is_state('binary_sensor.household_announce_adults', 'on') }}"
        household_home: "{{ is_state('group.household', 'home') }}"
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ household_home and can_announce_all }}"
          sequence:
            - repeat:
                for_each: "{{ tts_targets_all }}"
                sequence:
                  - variables:
                      prev_volume: "{{ state_attr(repeat.item, 'volume_level') }}"
                  - service: media_player.volume_set
                    target:
                      entity_id: "{{ repeat.item }}"
                    data:
                      volume_level: "{{ tts_volume }}"
                  - if:
                      - condition: template
                        value_template: "{{ camden_voice | length > 0 }}"
                    then:
                      - service: tts.speak
                        target:
                          entity_id: "{{ camden_tts }}"
                        data:
                          media_player_entity_id: "{{ repeat.item }}"
                          message: "{{ camden_message }}"
                          options:
                            voice: "{{ camden_voice }}"
                          cache: true
                    else:
                      - service: tts.speak
                        target:
                          entity_id: "{{ camden_tts }}"
                        data:
                          media_player_entity_id: "{{ repeat.item }}"
                          message: "{{ camden_message }}"
                          cache: true
                  - delay: "00:00:01"
                  - if:
                      - condition: template
                        value_template: "{{ poe_voice | length > 0 }}"
                    then:
                      - service: tts.speak
                        target:
                          entity_id: "{{ poe_tts }}"
                        data:
                          media_player_entity_id: "{{ repeat.item }}"
                          message: "{{ poe_message }}"
                          options:
                            voice: "{{ poe_voice }}"
                          cache: true
                    else:
                      - service: tts.speak
                        target:
                          entity_id: "{{ poe_tts }}"
                        data:
                          media_player_entity_id: "{{ repeat.item }}"
                          message: "{{ poe_message }}"
                          cache: true
                  - delay: "00:00:01"
                  - if:
                      - condition: template
                        value_template: "{{ prev_volume is not none }}"
                    then:
                      - service: media_player.volume_set
                        target:
                          entity_id: "{{ repeat.item }}"
                        data:
                          volume_level: "{{ prev_volume }}"
        - conditions:
            - condition: template
              value_template: "{{ household_home and can_announce_adults }}"
          sequence:
            - repeat:
                for_each: "{{ tts_targets_adult }}"
                sequence:
                  - variables:
                      prev_volume: "{{ state_attr(repeat.item, 'volume_level') }}"
                  - service: media_player.volume_set
                    target:
                      entity_id: "{{ repeat.item }}"
                    data:
                      volume_level: "{{ tts_volume }}"
                  - if:
                      - condition: template
                        value_template: "{{ camden_voice | length > 0 }}"
                    then:
                      - service: tts.speak
                        target:
                          entity_id: "{{ camden_tts }}"
                        data:
                          media_player_entity_id: "{{ repeat.item }}"
                          message: "{{ camden_message }}"
                          options:
                            voice: "{{ camden_voice }}"
                          cache: true
                    else:
                      - service: tts.speak
                        target:
                          entity_id: "{{ camden_tts }}"
                        data:
                          media_player_entity_id: "{{ repeat.item }}"
                          message: "{{ camden_message }}"
                          cache: true
                  - delay: "00:00:01"
                  - if:
                      - condition: template
                        value_template: "{{ poe_voice | length > 0 }}"
                    then:
                      - service: tts.speak
                        target:
                          entity_id: "{{ poe_tts }}"
                        data:
                          media_player_entity_id: "{{ repeat.item }}"
                          message: "{{ poe_message }}"
                          options:
                            voice: "{{ poe_voice }}"
                          cache: true
                    else:
                      - service: tts.speak
                        target:
                          entity_id: "{{ poe_tts }}"
                        data:
                          media_player_entity_id: "{{ repeat.item }}"
                          message: "{{ poe_message }}"
                          cache: true
                  - delay: "00:00:01"
                  - if:
                      - condition: template
                        value_template: "{{ prev_volume is not none }}"
                    then:
                      - service: media_player.volume_set
                        target:
                          entity_id: "{{ repeat.item }}"
                        data:
                          volume_level: "{{ prev_volume }}"

litterbot_nag_snooze:
  alias: Litterbot nag snooze
  description: Snooze Litterbot nag alerts for a set number of minutes.
  mode: single
  fields:
    minutes:
      description: Snooze duration in minutes.
      example: 90
  sequence:
    - variables:
        minutes: >-
          {{ minutes | default(states('input_number.litterbot_nag_snooze_minutes') | int(60)) | int(60) }}
        until: "{{ (now() + timedelta(minutes=minutes)).strftime('%Y-%m-%d %H:%M:%S') }}"
    - service: input_datetime.set_datetime
      target:
        entity_id: input_datetime.litterbot_nag_snooze_until
      data:
        datetime: "{{ until }}"

litterbot_nag_snooze_until_home:
  alias: Litterbot nag snooze until home
  description: Snooze Litterbot nag alerts until a person returns home.
  mode: single
  fields:
    person_entity:
      description: Person entity to wait for (e.g. person.ankit_aggarwal).
      example: person.ankit_aggarwal
  sequence:
    - variables:
        person_entity: >-
          {{ person_entity | default(states('input_text.litterbot_nag_snooze_until_home_person')) | default('person.ankit_aggarwal') }}
    - service: input_text.set_value
      target:
        entity_id: input_text.litterbot_nag_snooze_until_home_person
      data:
        value: "{{ person_entity }}"
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.litterbot_nag_snooze_until_home
    - service: input_datetime.set_datetime
      target:
        entity_id: input_datetime.litterbot_nag_snooze_until
      data:
        datetime: "{{ (now() - timedelta(minutes=1)).strftime('%Y-%m-%d %H:%M:%S') }}"

litterbot_nag_snooze_clear:
  alias: Litterbot nag snooze clear
  description: Clear any active Litterbot nag snooze.
  mode: single
  sequence:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.litterbot_nag_snooze_until_home
    - service: input_datetime.set_datetime
      target:
        entity_id: input_datetime.litterbot_nag_snooze_until
      data:
        datetime: "{{ (now() - timedelta(minutes=1)).strftime('%Y-%m-%d %H:%M:%S') }}"
