health_check_stale_entities:
  alias: Health check stale entities
  description: Add a todo item if an entity has not updated within N days.
  mode: parallel
  fields:
    entities:
      description: List of entities or dicts with entity_id and name.
      example: "binary_sensor.dining_room_smoke or {entity_id: binary_sensor.dining_room_smoke, name: Dining Room Smoke Detector}"
    stale_days:
      description: Number of days without updates before flagging.
      example: 30
    todo_list:
      description: Todo list entity to receive items.
      example: todo.shopping_list
  sequence:
    - variables:
        stale_days: "{{ stale_days | default(30) | int }}"
        todo_list: "{{ todo_list | default('todo.shopping_list') }}"
        notify_targets: "{{ notify_targets | default([]) }}"
        notify_title: "{{ notify_title | default('Home maintenance') }}"
    - repeat:
        for_each: "{{ entities | default([]) }}"
        sequence:
          - variables:
              entity_id: >-
                {{ repeat.item.entity_id if repeat.item is mapping else repeat.item }}
              label: >-
                {{ repeat.item.name if repeat.item is mapping else state_attr(entity_id, 'friendly_name') }}
              last_updated: >-
                {{ states[entity_id].last_updated if states[entity_id] is not none else none }}
              is_stale: >-
                {{ last_updated is none or
                   (as_timestamp(now()) - as_timestamp(last_updated)) > (stale_days * 86400) }}
              month_tag: "{{ now().strftime('%Y-%m') }}"
              todo_item: >-
                {{ 'Health check: ' ~ (label or entity_id) ~ ' (no update in ' ~ stale_days ~ 'd, ' ~ month_tag ~ ')' }}
          - if:
              - condition: template
                value_template: "{{ is_stale }}"
            then:
              - service: todo.add_item
                target:
                  entity_id: "{{ todo_list }}"
                data:
                  item: "{{ todo_item }}"
              - if:
                  - condition: template
                    value_template: "{{ notify_targets | count > 0 }}"
                then:
                  - repeat:
                      for_each: "{{ notify_targets }}"
                      sequence:
                        - service: "{{ repeat.item }}"
                          data:
                            title: "{{ notify_title }}"
                            message: "{{ todo_item }}"

list_disabled_scenes:
  alias: List disabled scenes
  description: Logs all currently disabled scenes to the system log. Check Settings > System > Logs to view.
  mode: single
  sequence:
    - service: system_log.write
      data:
        message: >-
          Disabled scenes (go to Settings > Devices & Services > Entities, filter by 'disabled' to re-enable):
          {% set ns = namespace(scenes=[]) %}
          {% for state in states.scene %}
            {% if state.entity_id in integration_entities('hue') or state.entity_id in integration_entities('tuya') %}
              {# Only list integration scenes, not manually created ones #}
            {% endif %}
          {% endfor %}
          Check entity registry for full list of disabled scenes.
        level: info
    - service: persistent_notification.create
      data:
        title: "Disabled Scenes"
        message: >-
          To view and re-enable disabled scenes:

          1. Go to **Settings** > **Devices & Services**
          2. Click **Entities** tab
          3. Click filter icon, enable "Show disabled entities"
          4. Search for "scene."
          5. Click any scene and toggle "Enabled" to re-enable it

alexa_announce_router:
  alias: Alexa announcement router
  description: Route announcements based on quiet hours and audience.
  mode: queued
  fields:
    message:
      description: Announcement text to speak.
      example: "The washer is done."
    audience:
      description: Audience routing (auto, all, adults, living_room).
      example: "auto"
  sequence:
    - variables:
        audience: "{{ audience | default('auto') }}"
        targets_all: !include alexa_announce_targets_all.yaml
        targets_adult: !include alexa_announce_targets_adult.yaml
        kids_home: >-
          {% set val = states('binary_sensor.kids_home') %}
          {% if val in ['on', 'off'] %}
            {{ val == 'on' }}
          {% else %}
            {{ is_state('group.kids', 'home') }}
          {% endif %}
        can_announce_all: >-
          {% set val = states('binary_sensor.household_announce_all') %}
          {% if val in ['on', 'off'] %}
            {{ val == 'on' }}
          {% else %}
            {% set now_minutes = now().hour * 60 + now().minute %}
            {% if kids_home %}
              {{ now_minutes >= 420 and now_minutes < 1200 }}
            {% else %}
              {{ now_minutes >= 420 and now_minutes < 1320 }}
            {% endif %}
          {% endif %}
        can_announce_adults: >-
          {% set val = states('binary_sensor.household_announce_adults') %}
          {% if val in ['on', 'off'] %}
            {{ val == 'on' }}
          {% else %}
            {% set now_minutes = now().hour * 60 + now().minute %}
            {{ now_minutes >= 420 and now_minutes < 1320 }}
          {% endif %}
        household_home: "{{ is_state('group.household', 'home') }}"
    - condition: template
      value_template: "{{ household_home }}"
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ audience == 'living_room' and can_announce_adults }}"
          sequence:
            - service: notify.alexa_media
              data:
                target:
                  - media_player.living_room_alexa
                message: "{{ message }}"
                data:
                  type: announce
                  method: all
        - conditions:
            - condition: template
              value_template: "{{ audience == 'all' and can_announce_all }}"
          sequence:
            - service: notify.alexa_media
              data:
                target: "{{ targets_all }}"
                message: "{{ message }}"
                data:
                  type: announce
                  method: all
        - conditions:
            - condition: template
              value_template: "{{ audience == 'adults' and can_announce_adults }}"
          sequence:
            - service: notify.alexa_media
              data:
                target: "{{ targets_adult }}"
                message: "{{ message }}"
                data:
                  type: announce
                  method: all
      default:
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ can_announce_all }}"
              sequence:
                - service: notify.alexa_media
                  data:
                    target: "{{ targets_all }}"
                    message: "{{ message }}"
                    data:
                      type: announce
                      method: all
            - conditions:
                - condition: template
                  value_template: "{{ can_announce_adults }}"
              sequence:
                - service: notify.alexa_media
                  data:
                    target: "{{ targets_adult }}"
                    message: "{{ message }}"
                    data:
                      type: announce
                      method: all
