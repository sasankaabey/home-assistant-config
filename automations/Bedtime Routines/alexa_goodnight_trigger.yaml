- id: alexa_goodnight_trigger
  alias: Alexa Routine - Trigger Goodnight on Last Called Device
  description: Sends goodnight prompt to the last Alexa device that heard the user
  trigger:
    - platform: state
      entity_id: input_boolean.goodnight_trigger
      to: "on"
  variables:
    last_called_device: >
      {% set entity = states.media_player | selectattr('attributes.last_called', 'defined') 
         | selectattr('attributes.last_called') | list | first %}
      {{ entity.entity_id if entity is not none else 'media_player.bedroom_echo' }}
  action:
    - service: script.activate_alexa_actionable_notification
      data:
        text: "Are you ready for bed?"
        event_id: goodnight_routine
        alexa_device: "{{ last_called_device }}"
        suppress_confirmation: "true"
    - delay: "00:00:10"
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.goodnight_trigger