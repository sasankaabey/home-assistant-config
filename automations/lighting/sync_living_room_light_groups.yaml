---
# Sync Living Room Light Groups
# Ensures all lights in a group stay in sync by stopping any Hue effects/loops
# before applying new state when controlled via HA/Alexa/Google/Siri

- id: sync_living_room_lamps_on_change
  alias: Sync Living Room Lamps on Change
  description: Stop effects and sync lights when Living Room Lamps is controlled
  trigger:
    - platform: state
      entity_id: light.living_room_lamps
  condition:
    # Only run if the change came from a service call (HA/Alexa/etc), not from Hue directly
    - condition: template
      value_template: "{{ trigger.to_state.context.parent_id is none }}"
  action:
    - variables:
        source_light: light.living_room_lamps
        brightness_val: "{{ state_attr(source_light, 'brightness') }}"
        color_mode: "{{ state_attr(source_light, 'color_mode') }}"
        color_temp_val: "{{ state_attr(source_light, 'color_temp') }}"
        rgb_val: "{{ state_attr(source_light, 'rgb_color') }}"
    - service: light.turn_on
      target:
        entity_id:
          - light.living_room_hue_iris
          - light.living_room_floor_lamp_2
          - light.living_room_floor_lamp
          - light.living_room_tv_light
      data:
        effect: "none"
        brightness: "{{ brightness_val }}"
        transition: 1
    # Apply color based on mode (can't set both color_temp and rgb_color)
    - if:
        - condition: template
          value_template: "{{ color_mode == 'color_temp' and color_temp_val is not none }}"
      then:
        - service: light.turn_on
          target:
            entity_id:
              - light.living_room_hue_iris
              - light.living_room_floor_lamp_2
              - light.living_room_floor_lamp
              - light.living_room_tv_light
          data:
            color_temp: "{{ color_temp_val }}"
      else:
        - if:
            - condition: template
              value_template: "{{ rgb_val is not none }}"
          then:
            - service: light.turn_on
              target:
                entity_id:
                  - light.living_room_hue_iris
                  - light.living_room_floor_lamp_2
                  - light.living_room_floor_lamp
                  - light.living_room_tv_light
              data:
                rgb_color: "{{ rgb_val }}"
  mode: restart

- id: sync_living_room_lights_on_change
  alias: Sync Living Room Lights on Change
  description: Stop effects and sync lights when Living Room Lights group is controlled
  trigger:
    - platform: state
      entity_id: light.living_room_lights
  condition:
    # Only run if the change came from a service call (HA/Alexa/etc), not from Hue directly
    - condition: template
      value_template: "{{ trigger.to_state.context.parent_id is none }}"
  action:
    - variables:
        source_light: light.living_room_lights
        brightness_val: "{{ state_attr(source_light, 'brightness') }}"
        color_mode: "{{ state_attr(source_light, 'color_mode') }}"
        color_temp_val: "{{ state_attr(source_light, 'color_temp') }}"
        rgb_val: "{{ state_attr(source_light, 'rgb_color') }}"
    - service: light.turn_on
      target:
        entity_id:
          - light.living_room_ceiling
          - light.living_room_tv_light
          - light.living_room_floor_lamp_2
          - light.living_room_floor_lamp
          - light.living_room_hue_iris
      data:
        effect: "none"
        brightness: "{{ brightness_val }}"
        transition: 1
    # Apply color based on mode (can't set both color_temp and rgb_color)
    - if:
        - condition: template
          value_template: "{{ color_mode == 'color_temp' and color_temp_val is not none }}"
      then:
        - service: light.turn_on
          target:
            entity_id:
              - light.living_room_ceiling
              - light.living_room_tv_light
              - light.living_room_floor_lamp_2
              - light.living_room_floor_lamp
              - light.living_room_hue_iris
          data:
            color_temp: "{{ color_temp_val }}"
      else:
        - if:
            - condition: template
              value_template: "{{ rgb_val is not none }}"
          then:
            - service: light.turn_on
              target:
                entity_id:
                  - light.living_room_ceiling
                  - light.living_room_tv_light
                  - light.living_room_floor_lamp_2
                  - light.living_room_floor_lamp
                  - light.living_room_hue_iris
              data:
                rgb_color: "{{ rgb_val }}"
  mode: restart
